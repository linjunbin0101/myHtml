<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="favicon.ico">
    <title>确认出场</title>
    <script type="text/javascript" src="https://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script type="text/javascript">
        let search = window.location.search;
        let api = 'https://pay.szzkc.com/PMasterAPI/api/Pay';
        (_ => {
            console.log(location.href, "location.href");
            console.log(location.href.substr(0, location.href.indexOf('code') - 1));

            if (search.indexOf('?') !== -1) {
                let request = new XMLHttpRequest();
                request.onreadystatechange = _ => {
                    if (request.readyState == 4 && request.status == 200) {
                        let result = JSON.parse(request.responseText);
                        if (result.Code == 0) {
                            let res = JSON.parse(result.Data);
                            wx.config({
                                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印
                                appId: res.appId, // 必填，公众号的唯一标识
                                timestamp: res.timestamp, // 必填，生成签名的时间戳
                                nonceStr: res.nonceStr, // 必填，生成签名的随机串
                                signature: res.signature, // 必填，签名
                                jsApiList: ['chooseImage', 'previewImage'], // 必填，需要使用的JS接口列表
                                openTagList: ['wx-open-launch-weapp'] // 可选，需要使用的开放标签列表，例如['wx-open-launch-app']
                            });
                        }
                    }
                }
                request.open('GET', `${api}/GetOpenXcxPar?url=${encodeURIComponent(location.href)}`, true);
                request.send();
            } else {
                console.log("search不包含？");
                alert('扫码识别有误，请重新扫描!')
            }
        })()
    </script>
</head>

<body>
    <div id="loadingDiv" class="loading-hidden">
        <svg t="1679391426481" class="loading-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2831" width="200" height="200"><path d="M876.864 782.592c3.264 0 6.272-3.2 6.272-6.656 0-3.456-3.008-6.592-6.272-6.592-3.264 0-6.272 3.2-6.272 6.592 0 3.456 3.008 6.656 6.272 6.656z m-140.544 153.344c2.304 2.432 5.568 3.84 8.768 3.84a12.16 12.16 0 0 0 8.832-3.84 13.76 13.76 0 0 0 0-18.56 12.224 12.224 0 0 0-8.832-3.84 12.16 12.16 0 0 0-8.768 3.84 13.696 13.696 0 0 0 0 18.56zM552.32 1018.24c3.456 3.648 8.32 5.76 13.184 5.76a18.368 18.368 0 0 0 13.184-5.76 20.608 20.608 0 0 0 0-27.968 18.368 18.368 0 0 0-13.184-5.824 18.368 18.368 0 0 0-13.184 5.76 20.608 20.608 0 0 0 0 28.032z m-198.336-5.76c4.608 4.8 11.072 7.68 17.6 7.68a24.448 24.448 0 0 0 17.536-7.68 27.456 27.456 0 0 0 0-37.248 24.448 24.448 0 0 0-17.536-7.68 24.448 24.448 0 0 0-17.6 7.68 27.52 27.52 0 0 0 0 37.184z m-175.68-91.84c5.76 6.08 13.824 9.6 21.952 9.6a30.592 30.592 0 0 0 22.016-9.6 34.368 34.368 0 0 0 0-46.592 30.592 30.592 0 0 0-22.016-9.6 30.592 30.592 0 0 0-21.952 9.6 34.368 34.368 0 0 0 0 46.592z m-121.152-159.36c6.912 7.36 16.64 11.648 26.368 11.648a36.736 36.736 0 0 0 26.432-11.584 41.28 41.28 0 0 0 0-55.936 36.736 36.736 0 0 0-26.432-11.584 36.8 36.8 0 0 0-26.368 11.52 41.28 41.28 0 0 0 0 56zM12.736 564.672a42.88 42.88 0 0 0 30.784 13.44 42.88 42.88 0 0 0 30.784-13.44 48.128 48.128 0 0 0 0-65.216 42.88 42.88 0 0 0-30.72-13.44 42.88 42.88 0 0 0-30.848 13.44 48.128 48.128 0 0 0 0 65.216z m39.808-195.392a48.96 48.96 0 0 0 35.2 15.36 48.96 48.96 0 0 0 35.2-15.36 54.976 54.976 0 0 0 0-74.56 48.96 48.96 0 0 0-35.2-15.424 48.96 48.96 0 0 0-35.2 15.424 54.976 54.976 0 0 0 0 74.56zM168.32 212.48c10.368 11.008 24.96 17.408 39.68 17.408 14.592 0 29.184-6.4 39.552-17.408a61.888 61.888 0 0 0 0-83.84 55.104 55.104 0 0 0-39.616-17.408c-14.656 0-29.248 6.4-39.616 17.408a61.888 61.888 0 0 0 0 83.84zM337.344 124.8c11.52 12.16 27.712 19.264 43.968 19.264 16.256 0 32.448-7.04 43.968-19.264a68.672 68.672 0 0 0 0-93.184 61.248 61.248 0 0 0-43.968-19.264 61.248 61.248 0 0 0-43.968 19.264 68.736 68.736 0 0 0 0 93.184z m189.632-1.088c12.672 13.44 30.528 21.248 48.448 21.248s35.712-7.808 48.384-21.248a75.584 75.584 0 0 0 0-102.464A67.392 67.392 0 0 0 575.36 0c-17.92 0-35.776 7.808-48.448 21.248a75.584 75.584 0 0 0 0 102.464z m173.824 86.592c13.824 14.592 33.28 23.104 52.736 23.104 19.584 0 39.04-8.512 52.8-23.104a82.432 82.432 0 0 0 0-111.744 73.472 73.472 0 0 0-52.8-23.168c-19.52 0-38.912 8.512-52.736 23.168a82.432 82.432 0 0 0 0 111.744z m124.032 158.528c14.976 15.872 36.032 25.088 57.216 25.088 21.12 0 42.24-9.216 57.152-25.088a89.344 89.344 0 0 0 0-121.088 79.616 79.616 0 0 0-57.152-25.088c-21.184 0-42.24 9.216-57.216 25.088a89.344 89.344 0 0 0 0 121.088z m50.432 204.032c16.128 17.088 38.784 27.008 61.632 27.008 22.784 0 45.44-9.92 61.568-27.008a96.256 96.256 0 0 0 0-130.432 85.76 85.76 0 0 0-61.568-27.072c-22.848 0-45.44 9.984-61.632 27.072a96.192 96.192 0 0 0 0 130.432z" fill="#262626" p-id="2832"></path></svg>
    </div>
    <div style="background: #e5e7e5;">
        <div style="min-height: 100vh;overflow: auto;font-size: 17px;width: 100vw;display: flex;justify-content: center;align-items: center;">
            <div id="FeeArea" style="border-radius: 8px;overflow: hidden;width: calc(90% - 30px);background: #FFF;padding: 15px;display: none;">
                <div style="text-align: center;font-size: 22px;">
                    <img id="CarImg" src='qrcode.jpg' style="display: none;width: 70%;margin: auto;">
                    <div id="CarNo" style="margin-bottom: 5px;"></div>
                </div>
                <div style="border-top: 0.5px solid #e5e7e5;margin: 5px 0;"></div>
                <div class="Parking-information-item">
                    <span>停车路段：</span>
                    <span id="CarArea"></span>
                </div>
                <div class="Parking-information-item">
                    <span>入场时间：</span>
                    <span id="CarInTime"></span>
                </div>
                <div class="Parking-information-item" id="Out" style="display: none;">
                    <span>出场时间：</span>
                    <span id="CIOutTime"></span>
                </div>
                <div class="Parking-information-item">
                    <span>支付状态：</span>
                    <span id="CIPayStatus"></span>
                </div>
                <div style="margin-top: 10px;display: block;" id="Appearance">
                    <wx-open-launch-weapp id="launch-btn1" username="gh_4b1ee4a63c2d" style="display: flex">
                        <template style="display: block; width: 100%">
							<button style="width: 100%;border-radius: 4px;padding: 10px 0;font-size: 15px;border: none;background: #409EFE;color: #FFF;">我要出场</button>
						</template>
                    </wx-open-launch-weapp>
                </div>
                <div style="margin-top: 10px;display: none;" id="details">
                    <wx-open-launch-weapp id="launch-btn2" username="gh_4b1ee4a63c2d" style="display: flex">
                        <template style="display: block; width: 100%">
							<button style="width: 100%;border-radius: 4px;padding: 10px 0;font-size: 15px;border: none;background: #409EFE;color: #FFF;">查看详情</button>
						</template>
                    </wx-open-launch-weapp>
                </div>
            </div>
        </div>
    </div>
</body>
<style type="text/css">
    body {
        margin: 0;
    }
    
    .Parking-information-item {
        display: flex;
        justify-content: space-between;
        color: #666;
        line-height: 25px;
    }
    
    .loading-hidden {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .loading-icon {
        width: 40px;
        height: 40px;
        position: relative;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin-left: -20px;
        margin-top: -20px;
        animation: rotation 1.5s linear infinite;
    }
    
    @keyframes rotation {
        from {
            -webkit-transform: rotate(0deg);
        }
        to {
            -webkit-transform: rotate(360deg);
        }
    }
</style>
<script src="./convert.js"></script>
<script type="text/javascript">
    let ua = window.navigator.userAgent;
    let obj = strUrlObj(search.substr(search.indexOf('?') + 1));
    let PayButton = document.getElementById("PayButton");
    let FeeArea = document.getElementById("FeeArea");
    let launch_btn1 = document.getElementById("launch-btn1");
    let launch_btn2 = document.getElementById("launch-btn2");
    let appearance = document.getElementById("Appearance");
    let details = document.getElementById("details");
    let loadingDiv = document.getElementById("loadingDiv");
    (_ => {
        if (!/MicroMessenger/.test(ua)) {
            // alert(ua);
            alert('请用微信扫码打开！');
            loadingDiv.style.display = "none"
            return
        }

        launch_btn1.addEventListener('launch', function(e) {
            console.log('success', e);
        });
        launch_btn1.addEventListener('error', function(e) {
            console.log('fail', e);
            alert('fail', e.detail);
        });
        launch_btn2.addEventListener('launch', function(e) {
            console.log('success', e);
        });
        launch_btn2.addEventListener('error', function(e) {
            console.log('fail', e);
            alert('fail', e.detail);
        });
        wx.ready(function(res) {
            console.log(res, "wx.ready");
        });
        wx.error(err => {
            console.log(err, "wx.error");
            alert(JSON.stringify(err));
        });

        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = _ => {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                console.log(xmlhttp.responseText);
                let res = JSON.parse(xmlhttp.responseText);
                if (res.Code == 0) {
                    document.getElementById("CarNo").innerText = res.Data.CINo; // 车牌号
                    document.getElementById("CarInTime").innerText = FormatDateTime(res.Data.CIInTime);
                    document.getElementById("CarArea").innerText = res.Data.CIParkName;
                    document.getElementById("CIPayStatus").innerText = res.Data.CIPayStatus == 10 ? "已支付" : "未支付";

                    if (res['Data']) {
                        if (res.Data.CIOutTime) {
                            document.getElementById("Out").style.display = 'flex';
                            document.getElementById("CIOutTime").innerText = FormatDateTime(res.Data.CIOutTime);
                        }
                        if (res.Data.CIImg) {
                            document.getElementById("CarImg").src = res.Data.CIImg;
                            document.getElementById("CarImg").style.display = "block";
                        }
                        console.log(document.body.clientWidth, "document.body.clientWidth");
                        if (res.Data['CIPayStatus'] == 10) { // 支付状态 10 已支付 20 未支付
                            launch_btn2.setAttribute('path', `pages/My/ParkingRecord?CarNo=${res.Data.CINo}`);
                            FeeArea.style.display = 'block';
                            appearance.style.display = 'none';
                            details.style.display = 'block';
                            loadingDiv.style.display = "none"
                            console.log("显示查看详情");
                        } else {
                            launch_btn1.setAttribute('path', `pages/index/ConfirmExit?q=${encodeURIComponent(location.href)}`);
                            FeeArea.style.display = 'block';
                            appearance.style.display = 'block';
                            details.style.display = 'none';
                            loadingDiv.style.display = "none"
                            console.log("显示我要出场");
                        }
                    }
                }
            }
        }
        xmlhttp.open('GET', `${api}/GetCarBaseInfo?CIID=${obj.CIID}&CarId=${obj.CarId}`, true);
        xmlhttp.send();
    })()
</script>

</html>